<!-- src/views/partials/js/calendar.ejs -->
<script>
  // Configuration from meta tags
  const CONFIG = {
    MIN_ADVANCE_DAYS: parseInt(
      document.querySelector('meta[name="min-advance-days"]')?.content || 60
    ),
    MAX_ADVANCE_DAYS: parseInt(
      document.querySelector('meta[name="max-advance-days"]')?.content || 120
    ),
    MAX_DAYS_PER_REQUEST: parseInt(
      document.querySelector('meta[name="max-days-per-request"]')?.content || 4
    ),
    REQUEST_TYPES: {
      REQ_DO: 'Day Off',
      PM_OFF: 'PM Off',
      AM_OFF: 'AM Off',
      FLIGHT: 'Flight',
    },
  };

  // Global state
  let existingRequests = [];
  let selectedDates = [];

  // Calendar Management Class
  class CalendarManager {
    constructor() {
      this.today = new Date();
      this.minDate = this.addDays(this.today, CONFIG.MIN_ADVANCE_DAYS);
      this.maxDate = this.addDays(this.today, CONFIG.MAX_ADVANCE_DAYS);

      // Allow viewing past requests - start from 3 months before today
      this.viewMinDate = this.addDays(this.today, -90);
      this.viewMaxDate = this.maxDate;

      this.currentViewStart = new Date(
        this.minDate.getFullYear(),
        this.minDate.getMonth(),
        1
      );
      this.monthsToShow = 3;
    }

    addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    getMonthsToDisplay() {
      const months = [];
      let current = new Date(this.currentViewStart);

      for (let i = 0; i < this.monthsToShow; i++) {
        months.push(new Date(current));
        current.setMonth(current.getMonth() + 1);
      }

      return months;
    }

    canNavigatePrevious() {
      const previousMonth = new Date(this.currentViewStart);
      previousMonth.setMonth(previousMonth.getMonth() - 1);
      const viewMinMonth = new Date(
        this.viewMinDate.getFullYear(),
        this.viewMinDate.getMonth(),
        1
      );
      return previousMonth >= viewMinMonth;
    }

    canNavigateNext() {
      const lastDisplayedMonth = new Date(this.currentViewStart);
      lastDisplayedMonth.setMonth(
        lastDisplayedMonth.getMonth() + this.monthsToShow - 1
      );
      const viewMaxMonth = new Date(
        this.viewMaxDate.getFullYear(),
        this.viewMaxDate.getMonth(),
        1
      );
      return lastDisplayedMonth < viewMaxMonth;
    }

    navigatePrevious() {
      if (this.canNavigatePrevious()) {
        this.currentViewStart.setMonth(this.currentViewStart.getMonth() - 1);
        this.generateCalendar();
        this.updateNavigationButtons();
      }
    }

    navigateNext() {
      if (this.canNavigateNext()) {
        this.currentViewStart.setMonth(this.currentViewStart.getMonth() + 1);
        this.generateCalendar();
        this.updateNavigationButtons();
      }
    }

    updateNavigationButtons() {
      const prevBtn = document.getElementById('prevMonthBtn');
      const nextBtn = document.getElementById('nextMonthBtn');
      const currentDisplay = document.getElementById('currentMonthDisplay');

      prevBtn.disabled = !this.canNavigatePrevious();
      nextBtn.disabled = !this.canNavigateNext();

      // Update current month display
      const months = this.getMonthsToDisplay();
      const startMonth = months[0].toLocaleDateString('en-US', {
        month: 'short',
        year: 'numeric',
      });
      const endMonth = months[months.length - 1].toLocaleDateString('en-US', {
        month: 'short',
        year: 'numeric',
      });
      currentDisplay.textContent = `${startMonth} - ${endMonth}`;
    }

    isDateAvailable(date) {
      return date >= this.minDate && date <= this.maxDate;
    }

    isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    generateCalendar() {
      const calendarGrid = document.getElementById('calendarGrid');
      calendarGrid.innerHTML = '';

      const months = this.getMonthsToDisplay();
      const allDatesInView = new Set();

      // First pass: collect all dates that will be displayed
      months.forEach((monthStart) => {
        const firstDay = new Date(
          monthStart.getFullYear(),
          monthStart.getMonth(),
          1
        );
        const lastDay = new Date(
          monthStart.getFullYear(),
          monthStart.getMonth() + 1,
          0
        );
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        for (let i = 0; i < 42; i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          allDatesInView.add(this.formatDate(currentDate));
        }
      });

      // Second pass: create month containers, only showing dates that belong to each month
      months.forEach((monthStart) => {
        const monthContainer = this.createMonthContainer(
          monthStart,
          allDatesInView
        );
        calendarGrid.appendChild(monthContainer);
      });

      this.updateNavigationButtons();
      // Restore selection highlighting after calendar regeneration
      this.updateDateSelection();
    }

    createMonthContainer(monthStart, allDatesInView) {
      const monthContainer = document.createElement('div');
      monthContainer.className = 'month-container';

      // Month header
      const monthHeader = document.createElement('div');
      monthHeader.className = 'month-header';
      monthHeader.textContent = monthStart.toLocaleDateString('en-US', {
        month: 'long',
        year: 'numeric',
      });

      // Weekday headers
      const weekdayHeader = document.createElement('div');
      weekdayHeader.className = 'weekday-header';
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach((day) => {
        const dayElement = document.createElement('div');
        dayElement.className = 'weekday';
        dayElement.textContent = day;
        weekdayHeader.appendChild(dayElement);
      });

      // Days grid
      const daysGrid = document.createElement('div');
      daysGrid.className = 'days-grid';

      const firstDay = new Date(
        monthStart.getFullYear(),
        monthStart.getMonth(),
        1
      );
      const lastDay = new Date(
        monthStart.getFullYear(),
        monthStart.getMonth() + 1,
        0
      );
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());

      for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);

        // Only create cell if this date belongs to current month or is adjacent and not shown elsewhere
        const isCurrentMonth = currentDate.getMonth() === monthStart.getMonth();
        const dateStr = this.formatDate(currentDate);

        let shouldShowDate = false;

        if (isCurrentMonth) {
          shouldShowDate = true;
        } else {
          // Show adjacent month dates only if they don't belong to another displayed month
          const dateMonth = new Date(
            currentDate.getFullYear(),
            currentDate.getMonth(),
            1
          );
          const isInOtherDisplayedMonth = this.getMonthsToDisplay().some(
            (month) =>
              month.getMonth() === dateMonth.getMonth() &&
              month.getFullYear() === dateMonth.getFullYear()
          );
          shouldShowDate = !isInOtherDisplayedMonth;
        }

        const dayCell = this.createDayCell(
          currentDate,
          monthStart,
          shouldShowDate
        );
        daysGrid.appendChild(dayCell);
      }

      monthContainer.appendChild(monthHeader);
      monthContainer.appendChild(weekdayHeader);
      monthContainer.appendChild(daysGrid);

      return monthContainer;
    }

    createDayCell(date, monthStart, shouldShowDate) {
      const dayCell = document.createElement('div');
      dayCell.className = 'day-cell';
      dayCell.dataset.date = this.formatDate(date);

      if (!shouldShowDate) {
        dayCell.style.visibility = 'hidden';
        return dayCell;
      }

      // Day number
      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      dayNumber.textContent = date.getDate();

      // Determine cell state
      const isCurrentMonth = date.getMonth() === monthStart.getMonth();
      const isAvailable = this.isDateAvailable(date);
      const isWeekend = this.isWeekend(date);

      if (!isCurrentMonth) {
        dayCell.classList.add('other-month');
      }

      if (isWeekend) {
        dayCell.classList.add('weekend');
      }

      if (!isAvailable) {
        dayCell.classList.add('unavailable');
      } else {
        dayCell.addEventListener('click', () => this.handleDateClick(date));
      }

      // Check for existing requests
      const existingRequest = this.getExistingRequest(date);
      if (existingRequest) {
        const requestElement = document.createElement('div');
        requestElement.className = `day-request request-${existingRequest.status.toLowerCase()}`;
        requestElement.textContent = CONFIG.REQUEST_TYPES[existingRequest.type];

        // Add tooltip
        dayCell.setAttribute('data-bs-toggle', 'tooltip');
        dayCell.setAttribute('data-bs-placement', 'top');
        dayCell.setAttribute(
          'title',
          `${this.formatDate(date)}: ${existingRequest.type} (${existingRequest.status})${
            existingRequest.customMessage
              ? ' - ' + existingRequest.customMessage
              : ''
          }`
        );

        dayCell.appendChild(requestElement);
      }

      dayCell.appendChild(dayNumber);
      return dayCell;
    }

    getExistingRequest(date) {
      const dateStr = this.formatDate(date);
      return existingRequests.find(
        (request) =>
          request.startDate === dateStr || request.endDate === dateStr
      );
    }

    handleDateClick(date) {
      if (!this.isDateAvailable(date)) return;

      const dateStr = this.formatDate(date);
      const existingRequest = this.getExistingRequest(date);

      if (existingRequest) {
        // TODO: Show request details modal
        showToast(`Request already exists for ${dateStr}`, 'info');
        return;
      }

      // Handle date selection for new requests
      const index = selectedDates.findIndex((d) => d.date === dateStr);

      if (index > -1) {
        // Deselect date
        selectedDates.splice(index, 1);
      } else {
        // Select date (check max limit)
        if (selectedDates.length >= CONFIG.MAX_DAYS_PER_REQUEST) {
          showToast(
            `Maximum ${CONFIG.MAX_DAYS_PER_REQUEST} dates allowed`,
            'warning'
          );
          return;
        }
        selectedDates.push({ date: dateStr, type: 'REQ_DO' });
      }

      this.updateDateSelection();
      this.updateFloatingButton();
    }

    updateDateSelection() {
      // Clear all selections
      document.querySelectorAll('.day-cell.selected').forEach((cell) => {
        cell.classList.remove('selected');
      });

      // Apply current selections
      selectedDates.forEach(({ date }) => {
        const cell = document.querySelector(`[data-date="${date}"]`);
        if (cell) {
          cell.classList.add('selected');
        }
      });
    }

    updateFloatingButton() {
      const button = document.getElementById('createRequestBtn');
      const buttonText = document.getElementById('requestBtnText');

      if (selectedDates.length > 0) {
        button.classList.add('show');
        if (buttonText) {
          buttonText.textContent = `Create Request (${selectedDates.length} day${selectedDates.length > 1 ? 's' : ''})`;
        }
      } else {
        button.classList.remove('show');
        if (buttonText) {
          buttonText.textContent = 'Make Request';
        }
      }
    }
  }

  // Initialize calendar
  const calendar = new CalendarManager();

  // API Functions
  async function loadExistingRequests() {
    try {
      const response = await fetch('/api/requests');
      const data = await response.json();

      if (data.success) {
        existingRequests = data.data;
        updateStatistics(data.data);
        calendar.generateCalendar();
        initializeTooltips();
      }
    } catch (error) {
      console.error('Error loading requests:', error);
      showToast('Failed to load existing requests', 'error');
    }
  }

  function updateStatistics(requests) {
    const pending = requests.filter((r) => r.status === 'PENDING').length;
    const approved = requests.filter((r) => r.status === 'APPROVED').length;
    const denied = requests.filter((r) => r.status === 'DENIED').length;

    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('deniedCount').textContent = denied;
    document.getElementById('totalCount').textContent = requests.length;
  }

  function initializeTooltips() {
    const tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    tooltipTriggerList.map(
      (tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl)
    );
  }

  // Group Request Modal Functions
  function openGroupRequestModal() {
    if (selectedDates.length === 0) {
      showToast('Please select dates first', 'warning');
      return;
    }

    // Create modal if it doesn't exist
    let modal = document.getElementById('groupRequestModal');
    if (!modal) {
      createGroupRequestModal();
      modal = document.getElementById('groupRequestModal');
    }

    // Populate dates in modal
    populateModalDates();

    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
  }

  function createGroupRequestModal() {
    const modalHTML = `
    <div class="modal fade" id="groupRequestModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-calendar-plus"></i> Create Time-Off Request
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="groupRequestForm">
              <div class="mb-3">
                <label class="form-label">Selected Dates</label>
                <div id="selectedDatesList" class="border rounded p-3 bg-light">
                  <!-- Dates will be populated here -->
                </div>
              </div>
              
              <div class="mb-3">
                <label for="customMessage" class="form-label">Custom Message (Optional)</label>
                <textarea 
                  class="form-control" 
                  id="customMessage" 
                  rows="3" 
                  placeholder="Additional information or reason for time-off...">
                </textarea>
              </div>
              
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <small>
                  Request will be sent to scheduling@tuifly.be for approval.
                  You can edit individual date types above if needed.
                </small>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="submitGroupRequest">
              <i class="bi bi-send me-1"></i>
              Submit Request
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  function populateModalDates() {
    const container = document.getElementById('selectedDatesList');
    container.innerHTML = '';

    selectedDates.forEach((dateObj, index) => {
      const date = new Date(dateObj.date);
      const dateStr = date.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric',
      });

      const dateRow = document.createElement('div');
      dateRow.className = 'row mb-2 align-items-center';
      dateRow.innerHTML = `
      <div class="col-md-6">
        <span class="fw-bold">${dateStr}</span>
      </div>
      <div class="col-md-4">
        <select class="form-select form-select-sm" onchange="updateDateType(${index}, this.value)">
          <option value="REQ_DO" ${dateObj.type === 'REQ_DO' ? 'selected' : ''}>Full Day Off</option>
          <option value="PM_OFF" ${dateObj.type === 'PM_OFF' ? 'selected' : ''}>PM Off</option>
          <option value="AM_OFF" ${dateObj.type === 'AM_OFF' ? 'selected' : ''}>AM Off</option>
          <option value="FLIGHT" ${dateObj.type === 'FLIGHT' ? 'selected' : ''}>Flight</option>
        </select>
      </div>
      <div class="col-md-2">
        <input 
          type="text" 
          class="form-control form-control-sm" 
          placeholder="TB###"
          value="${dateObj.flightNumber || ''}"
          ${dateObj.type === 'FLIGHT' ? '' : 'disabled style="display:none;"'}
          onchange="updateFlightNumber(${index}, this.value)"
          id="flight-${index}"
        />
      </div>
    `;

      container.appendChild(dateRow);
    });
  }

  function updateDateType(index, type) {
    selectedDates[index].type = type;

    // Show/hide flight number input
    const flightInput = document.getElementById(`flight-${index}`);
    if (type === 'FLIGHT') {
      flightInput.style.display = 'block';
      flightInput.disabled = false;
      flightInput.required = true;
    } else {
      flightInput.style.display = 'none';
      flightInput.disabled = true;
      flightInput.required = false;
      selectedDates[index].flightNumber = '';
    }
  }

  function updateFlightNumber(index, flightNumber) {
    selectedDates[index].flightNumber = flightNumber;
  }

  async function submitGroupRequest() {
    const customMessage = document.getElementById('customMessage').value.trim();

    // Validate flight numbers
    const flightDates = selectedDates.filter((d) => d.type === 'FLIGHT');
    for (const date of flightDates) {
      if (!date.flightNumber || !date.flightNumber.startsWith('TB')) {
        showToast('Flight numbers must start with "TB"', 'error');
        return;
      }
    }

    if (selectedDates.length === 0) return;

    try {
      const response = await fetch('/api/requests/group', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          dates: selectedDates,
          customMessage: customMessage || null,
        }),
      });

      const result = await response.json();

      if (result.success) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById('groupRequestModal')
        );
        modal.hide();

        // Clear selection
        selectedDates = [];
        calendar.updateDateSelection();
        calendar.updateFloatingButton();

        // Reload data
        await loadExistingRequests();

        showToast(result.message, 'success');
      } else {
        showToast(result.error, 'error');
      }
    } catch (error) {
      console.error('Error creating group request:', error);
      showToast('Failed to create request', 'error');
    }
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', async () => {
    // Initialize application
    await loadExistingRequests();

    // Setup event listeners
    document
      .getElementById('createRequestBtn')
      ?.addEventListener('click', openGroupRequestModal);

    // Month navigation
    document.getElementById('prevMonthBtn')?.addEventListener('click', () => {
      calendar.navigatePrevious();
    });

    document.getElementById('nextMonthBtn')?.addEventListener('click', () => {
      calendar.navigateNext();
    });

    // Modal event listeners
    document.addEventListener('click', (e) => {
      if (e.target.id === 'submitGroupRequest') {
        submitGroupRequest();
      }
    });

    // Clear form when modal is hidden
    document.addEventListener('hidden.bs.modal', (e) => {
      if (e.target.id === 'groupRequestModal') {
        document.getElementById('groupRequestForm')?.reset();
        document.getElementById('customMessage').value = '';
      }
    });
  });

  // Utility Functions
  function formatDateForDisplay(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
    });
  }
</script>
